version: '3.8'

networks:
  proxy-network:
    external: true
  app-network:
    driver: bridge

services:
  backend:
    build: ./backend
    container_name: ${BACKEND_CONTAINER_NAME}
    expose:
      - "${BACKEND_PORT}"
    env_file:
      - .env
    environment:
      - VIRTUAL_HOST=${DOMAIN}
      - VIRTUAL_PATH=${BACKEND_VIRTUAL_PATH}
      - VIRTUAL_PORT=${BACKEND_PORT}
      - LETSENCRYPT_HOST=${DOMAIN}
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL}
      - HTTPS_METHOD=${HTTPS_METHOD}
      - ENABLE_HTTP_ON_MISSING_CERT=${ENABLE_HTTP_ON_MISSING_CERT}
    volumes:
      - ./backend:/app
      - /app/node_modules
      - ./backend/uploads:/app/uploads
    restart: unless-stopped
    networks:
      - proxy-network
      - app-network
    depends_on:
      - db

  frontend:
    build:
      context: ./frontend
      args:
        - VITE_API_URL=${VITE_API_URL}
        - VITE_EVENT_ADDRESS=${VITE_EVENT_ADDRESS}
        - VITE_ADMIN_EMAILS=${VITE_ADMIN_EMAILS}
        - VITE_SUPABASE_URL=${SUPABASE_PUBLIC_URL}
        - VITE_SUPABASE_ANON_KEY=${ANON_KEY}
    container_name: ${FRONTEND_CONTAINER_NAME}
    expose:
      - "${FRONTEND_PORT}"
    env_file:
      - .env
    environment:
      - VIRTUAL_HOST=${DOMAIN}
      - VIRTUAL_PORT=${FRONTEND_PORT}
      - LETSENCRYPT_HOST=${DOMAIN}
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL}
      - HTTPS_METHOD=${HTTPS_METHOD}
      - ENABLE_HTTP_ON_MISSING_CERT=${ENABLE_HTTP_ON_MISSING_CERT}
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - proxy-network
      - app-network

  # Supabase services
  studio:
    container_name: supabase-studio
    image: supabase/studio:2025.10.27-sha-85b84e0
    restart: unless-stopped
    env_file:
      - .env
    networks:
      - app-network
    depends_on:
      - analytics
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "fetch('http://studio:3000/api/platform/profile').then((r) => {if (r.status !== 200) throw new Error(r.status)})"
        ]
      timeout: 10s
      interval: 5s
      retries: 3

  kong:
    container_name: supabase-kong
    image: kong:2.8.1
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - ${KONG_HTTP_PORT}:8000/tcp
      - ${KONG_HTTPS_PORT}:8443/tcp
    volumes:
      - ./supabase/volumes/api/kong.yml:/home/kong/temp.yml:ro
    networks:
      - app-network
    depends_on:
      - analytics
    entrypoint: bash -c 'eval "echo \"$$(cat ~/temp.yml)\"" > ~/kong.yml && /docker-entrypoint.sh kong docker-start'

  auth:
    container_name: supabase-auth
    image: supabase/gotrue:v2.180.0
    restart: unless-stopped
    env_file:
      - .env
    networks:
      - app-network
    depends_on:
      - db
      - analytics
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:9999/health"
        ]
      timeout: 5s
      interval: 5s
      retries: 3

  rest:
    container_name: supabase-rest
    image: postgrest/postgrest:v13.0.7
    restart: unless-stopped
    env_file:
      - .env
    networks:
      - app-network
    depends_on:
      - db
      - analytics

  realtime:
    container_name: realtime-dev.supabase-realtime
    image: supabase/realtime:v2.57.2
    restart: unless-stopped
    env_file:
      - .env
    networks:
      - app-network
    depends_on:
      - db
      - analytics
    healthcheck:
      test:
        [
          "CMD",
          "curl",
          "-sSfL",
          "--head",
          "-o",
          "/dev/null",
          "-H",
          "Authorization: Bearer ${ANON_KEY}",
          "http://localhost:4000/api/tenants/realtime-dev/health"
        ]
      timeout: 5s
      interval: 5s
      retries: 3

  storage:
    container_name: supabase-storage
    image: supabase/storage-api:v1.28.2
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - ./supabase/volumes/storage:/var/lib/storage
    networks:
      - app-network
    depends_on:
      - db
      - rest
      - imgproxy
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://storage:5000/status"
        ]
      timeout: 5s
      interval: 5s
      retries: 3

  imgproxy:
    container_name: supabase-imgproxy
    image: darthsim/imgproxy:v3.8.0
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - ./supabase/volumes/storage:/var/lib/storage
    networks:
      - app-network
    healthcheck:
      test:
        [
          "CMD",
          "imgproxy",
          "health"
        ]
      timeout: 5s
      interval: 5s
      retries: 3

  meta:
    container_name: supabase-meta
    image: supabase/postgres-meta:v0.93.1
    restart: unless-stopped
    env_file:
      - .env
    networks:
      - app-network
    depends_on:
      - db
      - analytics

  functions:
    container_name: supabase-edge-functions
    image: supabase/edge-runtime:v1.69.15
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - ./supabase/volumes/functions:/home/deno/functions
    networks:
      - app-network
    depends_on:
      - analytics
    command:
      [
        "start",
        "--main-service",
        "/home/deno/functions/main"
      ]

  analytics:
    container_name: supabase-analytics
    image: supabase/logflare:1.22.6
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - 4000:4000
    networks:
      - app-network
    depends_on:
      - db
    healthcheck:
      test:
        [
          "CMD",
          "curl",
          "http://localhost:4000/health"
        ]
      timeout: 5s
      interval: 5s
      retries: 10

  db:
    container_name: supabase-db
    image: supabase/postgres:15.8.1.085
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - ./supabase/volumes/db/realtime.sql:/docker-entrypoint-initdb.d/migrations/99-realtime.sql
      - ./supabase/volumes/db/webhooks.sql:/docker-entrypoint-initdb.d/init-scripts/98-webhooks.sql
      - ./supabase/volumes/db/roles.sql:/docker-entrypoint-initdb.d/init-scripts/99-roles.sql
      - ./supabase/volumes/db/jwt.sql:/docker-entrypoint-initdb.d/init-scripts/99-jwt.sql
      - ./supabase/volumes/db/data:/var/lib/postgresql/data
      - ./supabase/volumes/db/_supabase.sql:/docker-entrypoint-initdb.d/migrations/97-_supabase.sql
      - ./supabase/volumes/db/logs.sql:/docker-entrypoint-initdb.d/migrations/99-logs.sql
      - ./supabase/volumes/db/pooler.sql:/docker-entrypoint-initdb.d/migrations/99-pooler.sql
      - db-config:/etc/postgresql-custom
    networks:
      - app-network
    depends_on:
      - vector
    healthcheck:
      test:
        [
        "CMD",
        "pg_isready",
        "-U",
        "postgres",
        "-h",
        "localhost"
        ]
      interval: 5s
      timeout: 5s
      retries: 10
    command:
      [
        "postgres",
        "-c",
        "config_file=/etc/postgresql/postgresql.conf",
        "-c",
        "log_min_messages=fatal"
      ]

  vector:
    container_name: supabase-vector
    image: timberio/vector:0.28.1-alpine
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - ./supabase/volumes/logs/vector.yml:/etc/vector/vector.yml:ro
      - ${DOCKER_SOCKET_LOCATION}:/var/run/docker.sock:ro
    networks:
      - app-network
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://vector:9001/health"
        ]
      timeout: 5s
      interval: 5s
      retries: 3
    security_opt:
      - "label=disable"

  supavisor:
    container_name: supabase-pooler
    image: supabase/supavisor:2.7.3
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - ${POSTGRES_PORT}:5432
      - ${POOLER_PROXY_PORT_TRANSACTION}:6543
    volumes:
      - ./supabase/volumes/pooler/pooler.exs:/etc/pooler/pooler.exs:ro
    networks:
      - app-network
    depends_on:
      - db
      - analytics
    healthcheck:
      test:
        [
          "CMD",
          "curl",
          "-sSfL",
          "--head",
          "-o",
          "/dev/null",
          "http://127.0.0.1:4000/api/health"
        ]
      interval: 10s
      timeout: 5s
      retries: 5
    command:
      [
        "/bin/sh",
        "-c",
        "/app/bin/migrate && /app/bin/supavisor eval \"$$(cat /etc/pooler/pooler.exs)\" && /app/bin/server"
      ]

volumes:
  db-config:
